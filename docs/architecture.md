# Архитектура MaK CRM (2025)

## 1. Общая архитектура системы

### 1.1. Архитектурный подход
MaK CRM построена на основе модульной архитектуры с элементами микросервисного подхода. Система разделена на независимые модули, которые могут быть разработаны, развернуты и масштабированы отдельно друг от друга. Это обеспечивает гибкость, расширяемость и отказоустойчивость системы.

### 1.2. Ключевые принципы архитектуры
- **Модульность**: система разделена на независимые модули с четко определенными интерфейсами
- **Слабая связанность**: модули взаимодействуют через API, минимизируя зависимости
- **Высокая связность**: каждый модуль отвечает за конкретную бизнес-функцию
- **Масштабируемость**: возможность горизонтального масштабирования компонентов
- **Отказоустойчивость**: отказ одного модуля не приводит к отказу всей системы
- **Расширяемость**: возможность добавления новых модулей без изменения существующих

### 1.3. Высокоуровневая схема архитектуры

```
┌────────────────────────────────────────────────────────────────────────┐
│                             Клиентский уровень                          │
│                                                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  Web-    │  │ Мобильная│  │ Telegram │  │  PWA     │  │ Внешние  │  │
│  │ интерфейс│  │ версия   │  │   бот    │  │          │  │ системы  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                              API Gateway                                │
│                                                                        │
│  ┌──────────────────┐  ┌───────────────┐  ┌──────────────────────────┐ │
│  │ Аутентификация и │  │ Маршрутизация │  │ Документация API         │ │
│  │   авторизация    │  │   запросов    │  │ (Swagger/OpenAPI)        │ │
│  └──────────────────┘  └───────────────┘  └──────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                           Сервисный уровень                            │
│                                                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Клиенты  │  │  Сделки  │  │ Партнеры │  │Аналитика │  │Компоненты│  │
│  │ и лиды   │  │ и воронки│  │и франчайзи│ │ и отчеты │  │и плагины │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │Интеграции│  │Уведомления│ │Пользователи│ │Документы │  │  Аудит   │  │
│  │          │  │          │  │ и права   │  │и файлы   │  │и логи    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────┐
│                            Уровень данных                              │
│                                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │  PostgreSQL  │  │ Redis Cache  │  │ Object Storage│ │ ElasticSearch│ │
│  │  (основная БД)│ │ (кэширование)│  │  (файлы)     │  │  (поиск)    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
└────────────────────────────────────────────────────────────────────────┘
```

## 2. Клиентский уровень

### 2.1. Web-интерфейс
- **Технологии**: React, Mantine, TanStack Table, dnd-kit, Recharts/Nivo
- **Архитектура**: Single Page Application (SPA) с модульной структурой
- **Основные модули**:
  - **Core**: ядро приложения, роутинг, авторизация, общие компоненты
  - **Clients**: управление клиентами и лидами
  - **Deals**: управление сделками и воронками продаж
  - **Partners**: партнерский кабинет
  - **Analytics**: аналитика и отчеты
  - **Settings**: настройки системы и пользователя
  - **Components**: каталог компонентов и плагинов

### 2.2. Мобильная версия
- Адаптивный дизайн на основе web-интерфейса
- Оптимизация для мобильных устройств (упрощенный интерфейс)
- Поддержка установки как PWA (Progressive Web App)

### 2.3. Telegram-бот
- Интеграция с API через отдельный сервис
- Основные функции:
  - Уведомления о событиях
  - Просмотр информации по клиентам/сделкам
  - Выполнение базовых действий
  - Регистрация новых партнеров

### 2.4. Внешние системы
- Интеграция через API Gateway
- Поддержка OAuth 2.0 для авторизации
- Ограничение доступа по IP и токенам

## 3. API Gateway

### 3.1. Основные функции
- Единая точка входа для всех клиентов
- Маршрутизация запросов к соответствующим сервисам
- Аутентификация и авторизация
- Логирование запросов
- Ограничение частоты запросов (rate limiting)
- Кэширование ответов
- Документация API (Swagger/OpenAPI)

### 3.2. Технологии
- NestJS Gateway Module
- JWT для аутентификации
- Redis для кэширования и rate limiting
- Swagger/OpenAPI для документации

## 4. Сервисный уровень

### 4.1. Модуль "Клиенты и лиды"
- **Функции**:
  - Управление клиентами и контактами
  - Импорт/экспорт клиентов
  - Сегментация клиентов
  - Управление статусами
  - История изменений
- **API**:
  - `/api/clients` - CRUD операции с клиентами
  - `/api/clients/import` - импорт клиентов
  - `/api/clients/export` - экспорт клиентов
  - `/api/clients/segments` - управление сегментами
  - `/api/clients/history` - история изменений

### 4.2. Модуль "Сделки и воронки"
- **Функции**:
  - Управление сделками
  - Настройка воронок продаж
  - Автоматизация процессов
  - Задачи и напоминания
  - История изменений
- **API**:
  - `/api/deals` - CRUD операции со сделками
  - `/api/pipelines` - управление воронками
  - `/api/pipelines/stages` - управление этапами
  - `/api/pipelines/actions` - автоматизация
  - `/api/tasks` - задачи и напоминания

### 4.3. Модуль "Партнеры и франчайзи"
- **Функции**:
  - Управление партнерами и франчайзи
  - Настройка прав и ролей
  - Реферальная программа
  - Взаиморасчеты
  - Аукцион лидов
- **API**:
  - `/api/partners` - CRUD операции с партнерами
  - `/api/partners/roles` - управление ролями
  - `/api/partners/referrals` - реферальная программа
  - `/api/partners/payments` - взаиморасчеты
  - `/api/partners/auction` - аукцион лидов

### 4.4. Модуль "Аналитика и отчеты"
- **Функции**:
  - Конструктор отчетов
  - Дашборды
  - Экспорт данных
  - Визуализация
- **API**:
  - `/api/analytics/reports` - управление отчетами
  - `/api/analytics/dashboards` - управление дашбордами
  - `/api/analytics/export` - экспорт данных
  - `/api/analytics/data` - получение данных для отчетов

### 4.5. Модуль "Компоненты и плагины"
- **Функции**:
  - Управление компонентами
  - Включение/отключение компонентов
  - Настройка параметров
  - Управление зависимостями
- **API**:
  - `/api/components` - CRUD операции с компонентами
  - `/api/components/settings` - настройка компонентов
  - `/api/components/dependencies` - управление зависимостями
  - `/api/components/catalog` - каталог компонентов

### 4.6. Модуль "Интеграции"
- **Функции**:
  - Интеграция с AmoCRM
  - Интеграция с Telegram
  - Управление webhook'ами
  - Настройка интеграций
- **API**:
  - `/api/integrations` - CRUD операции с интеграциями
  - `/api/integrations/amo` - интеграция с AmoCRM
  - `/api/integrations/telegram` - интеграция с Telegram
  - `/api/integrations/webhooks` - управление webhook'ами

### 4.7. Модуль "Уведомления"
- **Функции**:
  - Отправка уведомлений
  - Настройка шаблонов
  - Настройка каналов (email, Telegram, push)
  - История уведомлений
- **API**:
  - `/api/notifications` - CRUD операции с уведомлениями
  - `/api/notifications/templates` - управление шаблонами
  - `/api/notifications/channels` - настройка каналов
  - `/api/notifications/history` - история уведомлений

### 4.8. Модуль "Пользователи и права"
- **Функции**:
  - Управление пользователями
  - Управление ролями и правами
  - Аутентификация и авторизация
  - Двухфакторная аутентификация
- **API**:
  - `/api/users` - CRUD операции с пользователями
  - `/api/roles` - управление ролями
  - `/api/permissions` - управление правами
  - `/api/auth` - аутентификация и авторизация

### 4.9. Модуль "Документы и файлы"
- **Функции**:
  - Управление документами
  - Загрузка и скачивание файлов
  - Генерация документов по шаблонам
  - Версионирование документов
- **API**:
  - `/api/documents` - CRUD операции с документами
  - `/api/files` - управление файлами
  - `/api/templates` - управление шаблонами документов
  - `/api/documents/generate` - генерация документов

### 4.10. Модуль "Аудит и логи"
- **Функции**:
  - Логирование действий пользователей
  - Аудит изменений данных
  - Мониторинг активности
  - Отчеты по безопасности
- **API**:
  - `/api/audit` - получение данных аудита
  - `/api/logs` - получение логов
  - `/api/audit/reports` - отчеты по аудиту
  - `/api/audit/alerts` - оповещения о подозрительной активности

## 5. Уровень данных

### 5.1. PostgreSQL
- **Основная БД** для хранения структурированных данных
- **Схемы данных**:
  - `clients` - клиенты и контакты
  - `deals` - сделки и воронки
  - `partners` - партнеры и франчайзи
  - `users` - пользователи и роли
  - `analytics` - данные для аналитики
  - `components` - компоненты и плагины
  - `integrations` - интеграции
  - `notifications` - уведомления
  - `documents` - документы и шаблоны
  - `audit` - аудит и логи
- **Особенности**:
  - Использование JSONB для гибких полей
  - Партиционирование таблиц для оптимизации
  - Индексы для быстрого поиска
  - Триггеры для аудита изменений

### 5.2. Redis Cache
- **Кэширование** часто запрашиваемых данных
- **Сессии** пользователей
- **Rate limiting** для API
- **Очереди** для асинхронных задач

### 5.3. Object Storage (S3-совместимое)
- **Хранение файлов** (документы, изображения, вложения)
- **Версионирование** документов
- **Бэкапы** базы данных

### 5.4. ElasticSearch
- **Полнотекстовый поиск** по всем данным
- **Логирование** действий пользователей
- **Аналитика** по логам и аудиту

## 6. Взаимодействие компонентов

### 6.1. Синхронное взаимодействие
- **REST API** для основных операций
- **GraphQL** для сложных запросов (опционально)
- **WebSockets** для real-time обновлений

### 6.2. Асинхронное взаимодействие
- **Message Queue** (RabbitMQ или Redis) для асинхронных операций
- **Event Bus** для событийно-ориентированного взаимодействия
- **Webhooks** для интеграции с внешними системами

### 6.3. Схема взаимодействия модулей

```
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   Клиенты    │◄────►│    Сделки    │◄────►│   Партнеры   │
└──────┬───────┘      └──────┬───────┘      └──────┬───────┘
       │                     │                     │
       │                     ▼                     │
       │              ┌──────────────┐             │
       └─────────────►│  Аналитика   │◄────────────┘
                      └──────┬───────┘
                             │
                             ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  Интеграции  │◄────►│ Уведомления  │◄────►│ Пользователи │
└──────┬───────┘      └──────┬───────┘      └──────┬───────┘
       │                     │                     │
       │                     ▼                     │
       │              ┌──────────────┐             │
       └─────────────►│  Компоненты  │◄────────────┘
                      └──────┬───────┘
                             │
                             ▼
                     ┌──────────────┐
                     │ Документы и  │
                     │    файлы     │
                     └──────┬───────┘
                            │
                            ▼
                     ┌──────────────┐
                     │   Аудит и    │
                     │     логи     │
                     └──────────────┘
```

## 7. Безопасность

### 7.1. Аутентификация и авторизация
- **JWT** для аутентификации
- **RBAC** (Role-Based Access Control) для авторизации
- **Двухфакторная аутентификация**
- **OAuth 2.0** для внешних систем

### 7.2. Защита данных
- **Шифрование** чувствительных данных
- **HTTPS** для всех соединений
- **Валидация** входных данных
- **Защита от CSRF, XSS, SQL-инъекций**

### 7.3. Аудит и мониторинг
- **Логирование** всех действий пользователей
- **Мониторинг** подозрительной активности
- **Оповещения** о нарушениях безопасности

## 8. Расширяемость

### 8.1. Плагинная архитектура
- **Интерфейсы** для расширения функциональности
- **Хуки** для встраивания в существующие процессы
- **События** для реагирования на изменения

### 8.2. Каталог компонентов
- **Стандартизированный API** для компонентов
- **Управление зависимостями**
- **Версионирование** компонентов

### 8.3. Кастомизация
- **Настройка полей** и сущностей
- **Кастомные воронки** и процессы
- **Настройка интерфейса** пользователя

## 9. Производительность и масштабирование

### 9.1. Оптимизация производительности
- **Кэширование** часто запрашиваемых данных
- **Индексирование** для быстрого поиска
- **Пагинация** и ограничение выборок
- **Оптимизация запросов** к базе данных

### 9.2. Горизонтальное масштабирование
- **Кластеризация** сервисов
- **Балансировка нагрузки**
- **Репликация** данных
- **Шардирование** базы данных (при необходимости)

### 9.3. Мониторинг и оптимизация
- **Сбор метрик** производительности
- **Анализ узких мест**
- **Автоматическое масштабирование** при необходимости

## 10. Интеграция с внешними системами

### 10.1. AmoCRM
- **Двусторонняя синхронизация** клиентов и сделок
- **Маппинг полей** и статусов
- **Обработка webhook'ов**

### 10.2. Telegram
- **Бот для уведомлений** и базовых действий
- **Авторизация** через Telegram
- **Интеграция с личным кабинетом** партнера

### 10.3. API для внешних систем
- **REST API** с документацией
- **OAuth 2.0** для авторизации
- **Webhooks** для уведомлений о событиях

---

Данная архитектура обеспечивает модульность, масштабируемость и расширяемость системы, что соответствует требованиям ТЗ. Она позволяет независимо разрабатывать и развертывать отдельные модули, а также легко добавлять новые функции без изменения существующего кода.