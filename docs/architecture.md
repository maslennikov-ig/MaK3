# Архитектура проекта MaK 3 CRM

## Общий обзор архитектуры

---

### Практические архитектурные рекомендации

#### Фронтенд
- Разделяйте компоненты на презентационные и контейнерные
- Используйте серверные компоненты для запросов к API
- Создавайте хуки для повторно используемой логики

#### Бэкенд
- Следуйте принципам SOLID
- Используйте DTO для валидации входных данных
- Создавайте отдельные модули для каждой функциональной области

#### Безопасность
- Храните чувствительные данные в переменных окружения
- Используйте хеширование паролей с помощью bcrypt
- Настраивайте CORS для защиты от межсайтовых запросов

---

> **Принципы:**
> - Всегда сначала ищем готовую, поддерживаемую библиотеку или компонент, а не пишем с нуля.
> - Предпочитаем использовать самые новые, но стабильные версии библиотек, компонентов и модулей.
> - Если возникает проблема с зависимостями, и нет возможности обновить до последних стабильных версий — отказываемся от проблемного модуля и ищем современную альтернативу, а не фиксируем старую зависимость.
> - Всегда предлагать архитектурные улучшения и альтернативы, если это повысит модульность или масштабируемость.
> - Использовать современные best practices (feature/domain-based структура, Server Components, паттерны NestJS/Prisma и др.).
> - При необходимости ссылаться на официальную документацию и использовать инструменты поиска (Context7).
> - Для задач по безопасности явно указывать потенциальные риски и способы их минимизации.

Архитектура MaK 3 CRM построена на основе микросервисного подхода с использованием современных технологий. Основные компоненты:

1. **Frontend**: Next.js с App Router, React и TypeScript
2. **Backend**: NestJS с TypeScript
3. **Базы данных**: PostgreSQL, Redis, ElasticSearch
4. **Очереди сообщений**: BullMQ
5. **Real-time коммуникации**: WebSockets (Socket.IO)

Система спроектирована с учетом высокой нагрузки, масштабируемости и модульности.

## Frontend архитектура

### Компоненты
- **Next.js App Router**: Для маршрутизации и рендеринга страниц
- **Server Components**: Для оптимизации производительности и SEO
- **Client Components**: Для интерактивных элементов интерфейса
- **Mantine UI**: Для базовых компонентов интерфейса
- **TanStack Table**: Для работы с таблицами данных
- **dnd-kit**: Для функциональности drag-and-drop
- **Recharts/Nivo**: Для визуализации данных
- **React Hook Form**: Для управления формами
- **React Arborist**: Для древовидных структур данных

### Структура проекта
```
frontend/
├── app/                  # App Router структура
│   ├── (auth)/           # Группа маршрутов аутентификации
│   ├── (dashboard)/      # Группа маршрутов дашборда
│   ├── api/              # API Routes
│   └── layout.tsx        # Корневой layout
├── components/           # Общие компоненты
│   ├── ui/               # UI компоненты
│   ├── forms/            # Компоненты форм
│   └── layouts/          # Компоненты макетов
├── lib/                  # Утилиты и хелперы
├── hooks/                # Пользовательские хуки
├── store/                # Управление состоянием
└── public/               # Статические файлы
```

## Backend архитектура

### Компоненты
- **NestJS**: Основной фреймворк для бэкенда
- **Prisma ORM**: Для работы с базой данных
- **REST API**: Основной способ взаимодействия с клиентом
- **GraphQL (опционально)**: Для сложных запросов данных
- **WebSocket Gateway**: Для real-time коммуникаций
- **BullMQ**: Для фоновых задач и очередей
- **JWT**: Для аутентификации и авторизации

### Структура проекта
```
backend/
├── src/
│   ├── main.ts                # Точка входа
│   ├── app.module.ts          # Корневой модуль
│   ├── modules/               # Модули приложения
│   │   ├── auth/              # Модуль аутентификации
│   │   ├── users/             # Модуль пользователей
│   │   ├── clients/           # Модуль клиентов
│   │   ├── deals/             # Модуль сделок
│   │   └── components/        # Модуль компонентов
│   ├── common/                # Общие утилиты
│   │   ├── decorators/        # Декораторы
│   │   ├── filters/           # Фильтры исключений
│   │   ├── guards/            # Guards для защиты маршрутов
│   │   ├── interceptors/      # Перехватчики
│   │   └── pipes/             # Pipes для валидации
│   ├── config/                # Конфигурация
│   └── jobs/                  # Фоновые задачи
└── prisma/                    # Схема Prisma
```

## Архитектура баз данных

### PostgreSQL
- **Основная база данных** для хранения всех структурированных данных
- **Схема**:
  - Users (пользователи)
  - Roles (роли)
  - Permissions (разрешения)
  - Clients (клиенты)
  - Leads (лиды)
  - Deals (сделки)
  - Pipelines (воронки)
  - Stages (этапы воронок)
  - Components (компоненты)
  - ComponentConfigs (конфигурации компонентов)

### Redis
- **Кэширование** для улучшения производительности
- **Сессии** для хранения данных сессий
- **Очереди** для BullMQ
- **Pub/Sub** для WebSocket коммуникаций

### ElasticSearch
- **Полнотекстовый поиск** по клиентам, сделкам и документам
- **Аналитика** для построения отчетов и дашбордов

### Object Storage
- **Хранение файлов** и документов
- **Медиа-контент** для клиентов и сделок

## Архитектура каталога компонентов

### Концепция
Каталог компонентов представляет собой систему плагинов, которая позволяет расширять функциональность CRM без изменения основного кода.

### Структура компонента
Каждый компонент состоит из:
- **Манифест**: Описание компонента, его зависимостей и точек интеграции
- **Backend-часть**: NestJS модуль с контроллерами, сервисами и моделями
- **Frontend-часть**: React компоненты для UI
- **Конфигурация**: Настройки компонента

### Интеграция компонентов
- **API для компонентов**: Стандартизированный интерфейс для взаимодействия с ядром
- **Система событий**: Позволяет компонентам реагировать на события в системе
- **UI-интеграция**: Система "слотов" для встраивания UI компонентов

## Архитектура Real-time и фоновых задач

### WebSockets
- **Socket.IO с Redis адаптером** для масштабирования
- **Комнаты** для группировки пользователей
- **Аутентификация** для защиты соединений

### Очереди задач (BullMQ)
- **Очереди**:
  - EmailQueue: Для отправки email уведомлений
  - NotificationQueue: Для отправки уведомлений
  - SyncQueue: Для синхронизации с внешними системами
  - ReportQueue: Для генерации отчетов
- **Обработчики задач**: NestJS сервисы для обработки задач из очередей
- **Планировщик**: Для запуска периодических задач

## Архитектура безопасности

### Аутентификация
- **JWT токены** для аутентификации API
- **OAuth 2.0** для интеграции с внешними сервисами
- **Refresh токены** для продления сессий

### Авторизация
- **RBAC (Role-Based Access Control)** для управления доступом
- **Middleware** для проверки прав доступа
- **Guards** для защиты маршрутов

### Защита данных
- **Шифрование чувствительных данных**
- **Валидация входных данных**
- **Защита от CSRF, XSS и SQL-инъекций**

## Интеграции

### AmoCRM
- **Двусторонняя синхронизация** данных
- **Маппинг полей** между системами
- **Обработка конфликтов** при синхронизации

### Telegram-бот
- **Команды** для работы с клиентами и сделками
- **Уведомления** о событиях
- **Авторизация** пользователей

### API для внешних интеграций
- **REST API** с документацией Swagger/OpenAPI
- **Авторизация** через API ключи
- **Ограничение запросов** для защиты от DDoS

## Диаграмма архитектуры

```
+------------------+        +------------------+
|                  |        |                  |
|    Frontend      |<------>|    Backend       |
|    (Next.js)     |   API  |    (NestJS)      |
|                  |        |                  |
+------------------+        +--------+---------+
                                     |
                                     v
+------------------+        +------------------+
|                  |        |                  |
|    Redis         |<------>|    PostgreSQL    |
|    (Cache/Queue) |        |    (Main DB)     |
|                  |        |                  |
+------------------+        +------------------+
        |
        v
+------------------+        +------------------+
|                  |        |                  |
|    ElasticSearch |        |    Object        |
|    (Search)      |        |    Storage       |
|                  |        |                  |
+------------------+        +------------------+
```

## Принципы проектирования

1. **Микросервисная архитектура**: Разделение системы на независимые компоненты
2. **Domain-Driven Design**: Проектирование на основе бизнес-доменов
3. **SOLID принципы**: Для поддержания чистого и поддерживаемого кода
4. **REST и GraphQL**: Для гибкого API
5. **Event-Driven Architecture**: Для обработки асинхронных событий
6. **Continuous Integration/Deployment**: Для быстрой доставки изменений

## Технический долг и стратегия рефакторинга

1. **Мониторинг технического долга**: Использование инструментов статического анализа
2. **Регулярный рефакторинг**: Выделение времени в каждом спринте
3. **Тестовое покрытие**: Поддержание высокого уровня тестового покрытия
4. **Документация**: Поддержание актуальной документации

Эта архитектура обеспечивает гибкость, масштабируемость и модульность системы, что соответствует требованиям, указанным в роадмапе.
