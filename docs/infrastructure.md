# Инфраструктура MaK CRM (2025)

## 1. Общие принципы инфраструктуры

### 1.1. Основные требования
- **Надежность**: отказоустойчивость всех компонентов системы
- **Масштабируемость**: возможность горизонтального масштабирования
- **Безопасность**: защита данных и контроль доступа
- **Производительность**: быстрый отклик системы и оптимизация ресурсов
- **Мониторинг**: контроль состояния всех компонентов
- **Автоматизация**: CI/CD, автоматическое развертывание и масштабирование

### 1.2. Облачная инфраструктура
- **Основной провайдер**: Яндекс Облако (соответствие ФЗ-152)
- **Резервный провайдер**: VK Cloud (для обеспечения отказоустойчивости)
- **Модель развертывания**: гибридная (часть в облаке, часть на собственных серверах)
- **Контейнеризация**: Docker + Kubernetes для управления контейнерами

### 1.3. Схема инфраструктуры

```
┌─────────────────────────────────────────────────────────────────────────┐
│                             Яндекс Облако                               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       Kubernetes Cluster                         │   │
│  │                                                                  │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │   │
│  │  │ Frontend │  │ Backend  │  │   API    │  │ Микросервисы     │ │   │
│  │  │ Pods     │  │ Pods     │  │ Gateway  │  │ (интеграции и др.)│ │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘ │   │
│  │                                                                  │   │
│  │  ┌──────────────────────┐  ┌──────────────────────────────────┐ │   │
│  │  │ Ingress Controller   │  │ Service Mesh (опционально)       │ │   │
│  │  └──────────────────────┘  └──────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │ PostgreSQL  │  │    Redis    │  │ Object      │  │ ElasticSearch│    │
│  │ Cluster     │  │    Cluster  │  │ Storage     │  │ Cluster      │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ Мониторинг и логирование│  │ CI/CD Pipeline                      │  │
│  │ (Prometheus, Grafana,   │  │ (GitLab CI/Jenkins)                 │  │
│  │  Loki, Jaeger)          │  │                                     │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Резервный провайдер                            │
│                             (VK Cloud)                                  │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ Резервные копии данных  │  │ Standby кластер для аварийного      │  │
│  │                         │  │ восстановления                      │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Внешние интеграции                             │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ AmoCRM API              │  │ Telegram Bot API                    │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
│                                                                         │
│  ┌─────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ Платежные сервисы       │  │ Другие внешние API                  │  │
│  └─────────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. Компоненты инфраструктуры

### 2.1. Kubernetes Cluster
- **Назначение**: оркестрация контейнеров, управление развертыванием и масштабированием
- **Компоненты**:
  - **Master Nodes**: управление кластером (минимум 3 для высокой доступности)
  - **Worker Nodes**: выполнение рабочих нагрузок (автомасштабирование)
  - **Ingress Controller**: маршрутизация внешнего трафика
  - **Service Mesh** (опционально): управление сервис-сервис коммуникацией
- **Конфигурация**:
  - Автомасштабирование нод (Cluster Autoscaler)
  - Горизонтальное масштабирование подов (HPA)
  - Управление ресурсами (Resource Quotas, Limits)
  - Network Policies для безопасности
  - Persistent Volumes для хранения данных

### 2.2. Базы данных и хранилища

#### 2.2.1. PostgreSQL Cluster
- **Назначение**: основное хранилище структурированных данных
- **Конфигурация**:
  - Мастер-реплика с автоматическим failover
  - Минимум 3 ноды (1 мастер, 2 реплики)
  - Автоматическое резервное копирование
  - Point-in-time recovery
  - Шифрование данных
- **Ресурсы**:
  - CPU: 8-16 ядер на ноду
  - RAM: 32-64 ГБ на ноду
  - Диск: SSD, 1-2 ТБ на ноду

#### 2.2.2. Redis Cluster
- **Назначение**: кэширование, сессии, очереди задач
- **Конфигурация**:
  - Минимум 3 ноды для высокой доступности
  - Sentinel для мониторинга и автоматического failover
  - Persistence для сохранения данных
- **Ресурсы**:
  - CPU: 4-8 ядер на ноду
  - RAM: 16-32 ГБ на ноду
  - Диск: SSD, 100-200 ГБ на ноду

#### 2.2.3. Object Storage
- **Назначение**: хранение файлов, документов, изображений
- **Тип**: S3-совместимое хранилище (Яндекс Object Storage)
- **Конфигурация**:
  - Версионирование объектов
  - Политики жизненного цикла
  - Шифрование данных
  - Репликация между регионами

#### 2.2.4. ElasticSearch Cluster
- **Назначение**: полнотекстовый поиск, логирование, аналитика
- **Конфигурация**:
  - Минимум 3 ноды для высокой доступности
  - Шардирование и репликация индексов
  - Снэпшоты для резервного копирования
- **Ресурсы**:
  - CPU: 8-16 ядер на ноду
  - RAM: 32-64 ГБ на ноду
  - Диск: SSD, 500 ГБ - 1 ТБ на ноду

### 2.3. Сетевая инфраструктура

#### 2.3.1. Внешний доступ
- **Load Balancer**: балансировка нагрузки между нодами
- **CDN**: кэширование статического контента
- **WAF**: защита от веб-атак
- **DDoS Protection**: защита от DDoS-атак

#### 2.3.2. Внутренняя сеть
- **VPC**: изолированная виртуальная сеть
- **Subnets**: разделение на подсети (public, private)
- **Security Groups**: контроль доступа на уровне портов
- **VPN**: защищенный доступ для администраторов

### 2.4. Мониторинг и логирование

#### 2.4.1. Мониторинг
- **Prometheus**: сбор метрик
- **Grafana**: визуализация метрик
- **Alertmanager**: оповещения о проблемах
- **Node Exporter**: метрики серверов
- **Blackbox Exporter**: проверка доступности сервисов

#### 2.4.2. Логирование
- **Loki**: сбор и хранение логов
- **Fluentd/Fluent Bit**: сбор логов с контейнеров
- **Kibana**: визуализация и анализ логов
- **Jaeger/Zipkin**: трассировка запросов

#### 2.4.3. Метрики для мониторинга
- **Системные метрики**: CPU, RAM, диск, сеть
- **Kubernetes метрики**: состояние подов, нод, сервисов
- **Метрики приложений**: время отклика, ошибки, запросы в секунду
- **Бизнес-метрики**: количество пользователей, сделок, конверсии

### 2.5. CI/CD и автоматизация

#### 2.5.1. CI/CD Pipeline
- **GitLab CI/Jenkins**: автоматизация сборки и деплоя
- **Этапы**:
  - Build: сборка и тестирование кода
  - Test: автоматическое тестирование (unit, integration, e2e)
  - Security: проверка безопасности кода
  - Deploy: развертывание в разные окружения
  - Monitoring: проверка работоспособности после деплоя

#### 2.5.2. Инфраструктура как код (IaC)
- **Terraform**: управление облачной инфраструктурой
- **Helm Charts**: управление Kubernetes ресурсами
- **Ansible**: конфигурация серверов и сервисов

#### 2.5.3. GitOps
- **ArgoCD/Flux**: синхронизация Kubernetes с Git-репозиторием
- **Автоматическое развертывание** при изменении конфигурации
- **Rollback** в случае проблем

### 2.6. Безопасность

#### 2.6.1. Защита данных
- **Шифрование данных** в состоянии покоя и при передаче
- **Управление секретами** через Kubernetes Secrets или Vault
- **Регулярные бэкапы** с проверкой восстановления
- **Аудит доступа** к данным

#### 2.6.2. Сетевая безопасность
- **HTTPS** для всех соединений
- **Network Policies** в Kubernetes
- **Firewall** на уровне облака и приложений
- **VPN** для административного доступа

#### 2.6.3. Аутентификация и авторизация
- **OAuth 2.0/OpenID Connect** для аутентификации
- **RBAC** для авторизации в Kubernetes и приложениях
- **Двухфакторная аутентификация** для административного доступа
- **Audit Logging** всех действий пользователей

## 3. Окружения

### 3.1. Продакшн (Production)
- **Назначение**: рабочая среда для конечных пользователей
- **Требования**:
  - Высокая доступность (99.9%)
  - Автоматическое масштабирование
  - Полное резервное копирование
  - Строгий контроль доступа
  - Мониторинг 24/7
- **Инфраструктура**:
  - Kubernetes Cluster с минимум 3 master и 3+ worker нодами
  - PostgreSQL Cluster с минимум 3 нодами
  - Redis Cluster с минимум 3 нодами
  - ElasticSearch Cluster с минимум 3 нодами
  - Географически распределенное Object Storage

### 3.2. Предпродакшн (Staging)
- **Назначение**: тестирование перед выпуском в продакшн
- **Требования**:
  - Идентичная продакшну конфигурация, но с меньшими ресурсами
  - Тестовые данные, близкие к реальным
  - Автоматизированное тестирование
- **Инфраструктура**:
  - Kubernetes Cluster с 1 master и 2+ worker нодами
  - PostgreSQL с 1 мастером и 1 репликой
  - Redis с 1 мастером и 1 репликой
  - ElasticSearch с 1-3 нодами

### 3.3. Разработка (Development)
- **Назначение**: среда для разработки и тестирования
- **Требования**:
  - Быстрое развертывание изменений
  - Тестовые данные
  - Доступ для разработчиков
- **Инфраструктура**:
  - Kubernetes Cluster с 1 master и 1+ worker нодами
  - PostgreSQL с 1 нодой
  - Redis с 1 нодой
  - Минимальная конфигурация ElasticSearch

### 3.4. Тестирование (QA)
- **Назначение**: среда для тестирования новых функций
- **Требования**:
  - Изолированность от других сред
  - Возможность сброса к начальному состоянию
  - Инструменты для автоматизированного тестирования
- **Инфраструктура**:
  - Kubernetes Namespace в Development кластере
  - Отдельные инстансы баз данных

## 4. Резервное копирование и восстановление

### 4.1. Стратегия резервного копирования
- **Полные бэкапы**: еженедельно
- **Инкрементальные бэкапы**: ежедневно
- **Транзакционные логи**: каждые 15 минут
- **Хранение бэкапов**:
  - Основное хранилище: Object Storage в основном облаке
  - Резервное хранилище: Object Storage в резервном облаке
  - Срок хранения: 30 дней для ежедневных, 1 год для ежемесячных

### 4.2. Процедура восстановления
- **Автоматизированное восстановление** с использованием скриптов
- **Регулярное тестирование восстановления** (минимум раз в месяц)
- **Документированные процедуры** для различных сценариев восстановления
- **RPO (Recovery Point Objective)**: не более 15 минут
- **RTO (Recovery Time Objective)**: не более 1 часа

## 5. Масштабирование и производительность

### 5.1. Горизонтальное масштабирование
- **Автоматическое масштабирование** на основе метрик нагрузки
- **Kubernetes HPA** для масштабирования подов
- **Cluster Autoscaler** для масштабирования нод
- **Connection Pooling** для баз данных

### 5.2. Оптимизация производительности
- **CDN** для статического контента
- **Кэширование** часто запрашиваемых данных в Redis
- **Индексирование** в базах данных
- **Оптимизация запросов** и мониторинг производительности
- **Асинхронная обработка** тяжелых задач через очереди

### 5.3. Управление ресурсами
- **Resource Requests и Limits** для контейнеров
- **Quality of Service** классы в Kubernetes
- **Приоритетные классы** для критических сервисов
- **Вертикальное масштабирование** баз данных при необходимости

## 6. Непрерывность бизнеса

### 6.1. Высокая доступность
- **Multi-AZ** развертывание в облаке
- **Автоматический failover** для баз данных
- **Load Balancing** между нодами
- **Graceful Degradation** при частичных отказах

### 6.2. Аварийное восстановление (DR)
- **Резервный кластер** в другом регионе/облаке
- **Репликация данных** между регионами
- **Автоматизированное переключение** при отказе основного региона
- **Регулярное тестирование** процедуры DR

### 6.3. План обеспечения непрерывности бизнеса
- **Документированные процедуры** для различных сценариев отказов
- **Команда реагирования** на инциденты
- **Регулярные учения** по восстановлению
- **SLA** с определенными метриками доступности

## 7. Соответствие требованиям

### 7.1. Соответствие ФЗ-152
- **Хранение персональных данных** на территории РФ
- **Шифрование** персональных данных
- **Контроль доступа** к персональным данным
- **Аудит действий** с персональными данными
- **Документированные процедуры** обработки персональных данных

### 7.2. Безопасность
- **Регулярные проверки** безопасности (penetration testing)
- **Сканирование уязвимостей** в коде и инфраструктуре
- **Обновление компонентов** для устранения уязвимостей
- **Мониторинг безопасности** и реагирование на инциденты

## 8. Операционная поддержка

### 8.1. Мониторинг и оповещения
- **24/7 мониторинг** всех компонентов системы
- **Автоматические оповещения** о проблемах
- **Дежурства** команды поддержки
- **Эскалация инцидентов** по уровням критичности

### 8.2. Управление инцидентами
- **Классификация инцидентов** по уровням критичности
- **Процедуры реагирования** на различные типы инцидентов
- **Постмортем-анализ** инцидентов
- **Внедрение улучшений** на основе анализа инцидентов

### 8.3. Управление изменениями
- **Процедура согласования** изменений
- **Окна обслуживания** для плановых работ
- **Rollback-план** для каждого изменения
- **Тестирование изменений** перед внедрением

## 9. Оценка ресурсов и стоимости

### 9.1. Оценка ресурсов для MVP
- **Kubernetes**: 1 master, 3 worker ноды (8 CPU, 32 GB RAM каждая)
- **PostgreSQL**: 1 master, 2 replica (8 CPU, 32 GB RAM, 1 TB SSD каждая)
- **Redis**: 3 ноды (4 CPU, 16 GB RAM каждая)
- **ElasticSearch**: 3 ноды (8 CPU, 32 GB RAM, 500 GB SSD каждая)
- **Object Storage**: 1 TB с географической репликацией
- **Сеть**: Load Balancer, CDN, VPN, межрегиональный трафик

### 9.2. Оценка стоимости
- **Инфраструктура**: ~500-700 тыс. руб/месяц (Яндекс Облако)
- **Лицензии** (если необходимы): ~100-200 тыс. руб/месяц
- **Поддержка**: ~200-300 тыс. руб/месяц (DevOps команда)
- **Резервный провайдер**: ~200-300 тыс. руб/месяц
- **Итого**: ~1-1.5 млн. руб/месяц для полной инфраструктуры

### 9.3. Оптимизация стоимости
- **Автоматическое масштабирование** для оптимизации ресурсов
- **Spot-инстансы** для некритичных компонентов
- **Резервирование мощностей** для долгосрочного использования
- **Мониторинг использования** и оптимизация ресурсов

## 10. Требования к команде

### 10.1. DevOps инженеры
- **Знания и навыки**:
  - Kubernetes, Docker
  - CI/CD (GitLab CI, Jenkins)
  - IaC (Terraform, Helm, Ansible)
  - Мониторинг (Prometheus, Grafana)
  - Облачные провайдеры (Яндекс Облако, VK Cloud)
- **Количество**: минимум 2 человека для обеспечения поддержки 24/7

### 10.2. Системные администраторы
- **Знания и навыки**:
  - Linux администрирование
  - Сетевая инфраструктура
  - Базы данных (PostgreSQL, Redis, ElasticSearch)
  - Безопасность
- **Количество**: минимум 1-2 человека

### 10.3. Инженеры по безопасности
- **Знания и навыки**:
  - Безопасность приложений
  - Сетевая безопасность
  - Аудит и соответствие требованиям
  - Реагирование на инциденты
- **Количество**: минимум 1 человек (может быть совмещено с другими ролями)

---

Данная инфраструктура обеспечивает надежность, масштабируемость и безопасность системы, соответствуя требованиям ТЗ. Она позволяет гибко управлять ресурсами, обеспечивать высокую доступность и быстро восстанавливаться после сбоев.