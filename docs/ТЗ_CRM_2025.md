# Техническое задание (ТЗ) на разработку CRM-системы MaK 3 (2025)

## 1. Общие положения

### 1.1. Цель проекта
Создать современную, масштабируемую и визуально привлекательную CRM-платформу для автоматизации и стандартизации бизнес-процессов в сфере кредитного брокериджа. Система должна поддерживать расширение за счёт подключения новых компонентов, интеграций и индивидуальных настроек для разных типов пользователей (сотрудников, партнёров, франчайзи).

### 1.2. Основные задачи
- Ведение учёта клиентов и контрагентов, управление их статусами и историей взаимодействий
- Детальная аналитика (выручка, KPI, эффективность, партнёры, сегменты)
- Верификация заемщиков и управление процессом подачи заявок в банки
- Управление клиентскими базами, сегментация, импорт/экспорт
- Помощь в разработке кредитных программ
- Интеграция с AmoCRM и Telegram-ботом (на первом этапе)
- Возможность расширения через внутренний каталог компонентов
- Обучение партнёров и франчайзи (отдельный этап)

### 1.3. Целевая аудитория
- Внутренние сотрудники (администраторы, менеджеры, аналитики, брокеры)
- Партнёры и франчайзи (ограниченный доступ к своим клиентам, сделкам, аналитике)
- Сотрудники партнёров (ограниченные права, настраиваются партнёром)

---

## 2. Функциональные требования

### 2.1. Пользовательские роли и доступы
- **Администратор**: полный доступ, управление всеми сущностями, настройка ролей, интеграций, компонентов, просмотр и редактирование всех данных.
- **Менеджер/Сотрудник**: доступ к клиентам, сделкам, задачам по назначению и правам, создание и редактирование информации, работа с аналитикой в рамках своих прав.
- **Брокер**: работа с заявками клиентов, взаимодействие с банками, согласование планов подач, отслеживание статусов заявок.
- **Партнёр/Франчайзи**: доступ только к своим клиентам, сделкам, аналитике, настройка прав для своих сотрудников (не выше своих прав), управление воронками продаж, просмотр отчётов по своим данным.
- **Сотрудник партнёра**: права настраиваются партнёром, доступ ограничен только к разрешённым сущностям и действиям.

#### Требования к системе ролей:
- Гибкая система ролей и прав (RBAC), возможность создавать кастомные роли
- Ограничение доступа к клиентам, сделкам, аналитике по принадлежности к партнёру/франчайзи
- Возможность настройки доступных компонентов для каждой роли
- Многоуровневая система прав (чтение, запись, удаление, управление)
- Наследование и ограничение прав (партнёр не может дать больше прав, чем имеет сам)

### 2.2. Клиентская база
- **Список клиентов** с полями: ФИО, телефон, email, источник, дата создания, статус, партнёр, ответственный, история изменений, комментарии, вложения (документы)
- **Источники клиентов**:
  - Лиды от партнеров с кредитной историей и без
  - Собственная лидогенерация компании
  - Холодная база для первичной квалификации
  - Загрузка из внешних источников (справочники и профильные сайты)
  - Купленные базы
- **Способы добавления клиентов**:
  - Создание через Telegram-бот или личный кабинет партнёра
  - Импорт из Excel
  - Через API (интеграция с мессенджерами, площадками, профильными сайтами)
  - Ручное заведение сотрудниками
- **Сегментация** по источникам, статусам, ответственным, дате, способу обработки:
  - Собственная обработка через КЦ и ОП с интеграцией с AmoCRM
  - Обработка через партнёра/франчайзи
  - Распределение после аукциона
  - Перераспределение невыкупленных баз
- **Статусы клиентов**:
  - Новый (без обработки)
  - Лид от партнёра
  - Аукцион (для продажи франчайзи)
  - Не выкуплен (для обработки ОП компании)
  - Другие настраиваемые статусы
- **Управление клиентами**:
  - Перераспределение между сотрудниками и партнёрами
  - История изменений по каждому клиенту
  - Возможность добавления комментариев и вложений
- **Конструктор аналитических отчётов**: фильтрация и группировка по любым полям, сохранение шаблонов отчётов, экспорт данных
- **Доступ** к клиентам ограничивается ролями и принадлежностью к партнёру/франчайзи

### 2.3. Продажи и сделки
- **Множественные воронки продаж**
- **Сделки с привязкой к клиенту**: сумма, этап, ответственный, дата создания, история изменений, комментарии, вложения
- **Drag&Drop для управления стадиями сделок** (канбан-доска)
- **Inline-редактирование данных сделки** (прямо в таблице/карточке)
- **История изменений** по каждой сделке (логирование всех действий)
- **Задачи и напоминания** по сделке
- **Автоматизация переходов между этапами** (уведомления, автозадачи)
- **Трехколоночный интерфейс работы со сделками**:
  - Левая колонка: информация о клиенте/сделке
  - Центральная колонка: история взаимодействия
  - Правая колонка: панель автоматизаций
- **Автоматизации воронки продаж (Pipeline Actions)**:
  - Смена этапа, владельца
  - Автоматическое заполнение полей
  - Формирование документов
  - Отправка уведомлений
  - Создание задач
  - Запуск интеграций
  - Другие настраиваемые действия
- **Настройка воронок и автоматизаций**:
  - Создание и редактирование воронок
  - Настройка этапов (название, порядок, цвет, длительность)
  - Визуальный редактор автоматизаций
  - Условные действия и цепочки действий

### 2.4. Партнёрский кабинет
- **Доступ** только к своим клиентам, сделкам, воронкам, аналитике (настраиваемый)
- **Блоки общей информации**:
  - О компании (информация, реквизиты, анонсы мероприятий)
  - Обучение (статьи, видео, шаблоны документов)
  - Помощь (FAQ, связь с компанией, чаты)
- **Клиентская панель**:
  - Кабинет компании (реквизиты, ID, статус-грейды)
  - Лиды (форма заведения, интеграция с AmoCRM, статусы, комментарии)
  - Аналитика (конверсия, суммы выдачи, доход, калькулятор прибыли)
  - Геймификация и обучение (баллы, мероприятия, задания)
  - Взаиморасчеты (даты, суммы, комиссии, акты)
  - Реферальная программа (двухуровневая система, ссылки, статистика)
- **Настройка ролей** для сотрудников партнёра (в рамках своих прав)
- **Управление воронками продаж**, настройка этапов
- **Отдельный раздел** для партнёров/франчайзи с доступными им сущностями

### 2.5. Кабинет франчайзи
- **Общая информация** (как у партнёра)
- **Панель клиента**:
  - Карточка клиента (реквизиты, договор)
  - Обучение (шаблоны документов, анкеты, акты)
  - Лиды (импорт, ручное внесение, аукцион)
  - Встроенная CRM-система (сделки, этапы, автоматизация)
  - Аналитика (конструктор отчётов, встроенные отчёты)
  - Взаиморасчеты (комиссии, акты)
  - Управление сотрудниками (роли, права)
- **Взаимодействие с брокерами компании**:
  - План подач по банкам
  - Согласование плана
  - Отметка о последовательности подачи
  - Отслеживание статусов в реальном времени
  - Получение информации об одобрении/отказе

### 2.6. Интеграции
- **AmoCRM**: двусторонняя интеграция (импорт/экспорт клиентов, сделок, статусов, синхронизация данных, автоматическое обновление при изменениях)
- **Telegram-бот**: 
  - Уведомления о событиях (новый клиент, изменение статуса, задача)
  - Просмотр информации по клиенту/сделке
  - Выполнение базовых действий (смена статуса, добавление комментария)
  - Доступ к личному кабинету партнёра
  - Регистрация новых партнёров
  - Статистика и отчёты
- **API**: собственное REST API (Swagger/OpenAPI), поддержка авторизации, документация, возможность расширения под внешние интеграции
- **Дополнительные интеграции** (в будущем):
  - Платежные сервисы для взаиморасчетов
  - Телефония, мессенджеры, площадки
  - Сервисы верификации (Спарк, Госуслуги)
  - Почта, 1С, маркетинговые платформы

### 2.7. Каталог компонентов
- **Внутренний каталог компонентов**:
  - Дашборды и отчёты
  - Интеграции с внешними сервисами
  - Виджеты для интерфейса
  - Дополнительные модули (обучение, аукцион и др.)
- **Управление компонентами**:
  - Включение/отключение для разных ролей и пользователей
  - Настройка параметров компонентов
  - Управление зависимостями между компонентами
- **Правила разработки компонентов**:
  - Единый стиль и архитектура
  - API для взаимодействия с ядром системы
  - Документация и примеры
- **Подключение новых модулей** без остановки системы
- **Примеры компонентов**:
  - Отчёт по эффективности
  - Интеграция с внешней системой
  - Дополнительный виджет на дашборде
  - Модуль аукциона лидов

### 2.8. UI/UX
- **Дизайн**: современный, лёгкий, минималистичный (ориентир на лучшие практики и envycrm)
- **Фреймворк**: Next.js (React) с поддержкой SSR/SSG, App Router, Server Components
- **Темы**: поддержка светлой и тёмной темы, быстрый переключатель
- **Адаптивность**: полная поддержка планшетов и смартфонов, установка ярлыка на рабочий стол (PWA)
- **Производительность**: высокая скорость отклика интерфейса (SSR/SSG, Core Web Vitals, оптимизация изображений через next/image, мгновенное обновление данных без перезагрузки страницы)
- **Компоненты**: использование готовых open-source компонентов (Mantine, TanStack Table, dnd-kit, Recharts/Nivo, React Hook Form, React Arborist и др.)
- **Интерактивность**:
  - Drag&Drop для карточек, таблиц, списков
  - Inline-редактирование в таблицах и карточках
  - Трехколоночный интерфейс для работы со сделками
- **Кастомизация**: возможность настройки интерфейса пользователем (видимость блоков, порядок колонок, сохранение настроек)
- **Уведомления**: система оповещений о важных событиях (всплывающие, email, Telegram)

### 2.9. Аналитика и отчёты
- **Конструктор отчётов**: гибкая настройка по любым полям и сущностям
- **Встроенные отчёты**:
  - Воронка продаж (конверсия между этапами)
  - Эффективность сотрудников/партнёров
  - Финансовые показатели (выручка, комиссии)
  - Источники клиентов и их эффективность
  - Причины отказов
  - Статистика по банкам и продуктам
- **Дашборды**: настраиваемые панели с ключевыми показателями
- **Экспорт данных**: выгрузка в Excel, PDF, CSV
- **Визуализация**: графики, диаграммы, таблицы, тепловые карты
- **Сводная аналитика** по компании:
  - Количество/эффективность партнеров, франчайзи
  - Окупаемость инвестиций, финансовые показатели
  - БДР (бюджет доходов и расходов)

### 2.10. Безопасность и доступ
- **Аутентификация**:
  - Двухфакторная аутентификация (SMS, email, Telegram, приложения)
  - Интеграция с популярными сервисами авторизации РФ (Госуслуги, VK ID, Сбер ID и др.)
  - Настраиваемые политики паролей
- **Авторизация**:
  - Многоуровневая система прав
  - Разграничение доступа по ролям и принадлежности
  - Контроль доступа на уровне API
- **Защита данных**:
  - Соответствие ФЗ-152 (персональные данные)
  - Шифрование данных
  - Разграничение доступа
- **Аудит**:
  - Логирование всех действий пользователей
  - Отслеживание подозрительной активности
  - История изменений по всем сущностям
- **Управление пользователями**:
  - Временная блокировка/разблокировка
  - Управление сессиями
  - Ограничение доступа по IP/устройствам

---

## 3. Нефункциональные требования

### 3.1. Технологический стек
- **Frontend**:
  - React + Mantine (UI-компоненты, theming, формы, модальные окна, адаптивность)
  - TanStack Table (react-table v8) — для сложных таблиц, фильтрации, inline-редактирования
  - dnd-kit — для drag&drop, канбан-досок, сортировки
  - Recharts или Nivo — для графиков и аналитики
  - React Hook Form + Mantine Form — для сложных форм и валидации
  - React Arborist — для древовидных структур
  - Поддержка dark/light тем, адаптивный дизайн для всех устройств
- **Backend**:
  - NestJS (TypeScript)
  - REST API (Swagger/OpenAPI)
  - Опционально GraphQL для сложных запросов
- **БД**:
  - PostgreSQL (реляционная структура)
  - Поддержка JSONB для гибких полей
  - Оптимизация для аналитических запросов
- **Облако**:
  - Яндекс Облако (или аналог из РФ)
  - Поддержка Kubernetes для масштабирования
  - S3-совместимое хранилище для файлов
- **Разработка**:
  - Использование только современных и поддерживаемых библиотек
  - Минимизация ручной разработки
  - Анализ и подбор лучших open-source решений перед разработкой каждого модуля

### 3.2. Масштабируемость
- **Горизонтальное масштабирование**:
  - Кластеризация сервисов
  - Балансировка нагрузки
  - Репликация данных
- **Модульная архитектура**:
  - Каждый компонент — независимый модуль
  - Возможность подключать/отключать без остановки системы
  - Изолированные зоны ответственности
- **Микросервисная архитектура** для будущего расширения:
  - Независимое масштабирование сервисов
  - Отказоустойчивость
  - Возможность использования разных технологий для разных сервисов

### 3.3. Инфраструктура
- **CI/CD**:
  - Автоматическое тестирование покрытие не менее 80%
  - Непрерывная интеграция и доставка
  - Автоматический деплой
  - Возможность отката версий
- **Мониторинг и логирование**:
  - Сбор метрик (Prometheus, Grafana или аналоги)
  - Централизованное логирование
  - Отслеживание ошибок (Sentry или аналог)
  - Оповещения о проблемах
- **Резервное копирование**:
  - Регулярное резервное копирование БД и файлов
  - Возможность восстановления на любую точку
  - Географически распределенное хранение
- **Документация**:
  - Подробная документация по развёртыванию
  - Инструкции по эксплуатации
  - Руководства для пользователей разных ролей
- **Восстановление после сбоев**:
  - Автоматическое восстановление сервисов
  - Минимальное время простоя
  - Сохранение целостности данных

---

## 4. Этапы реализации (MVP)

### 4.1. Этап 1: Базовая CRM (2-3 месяца)
- Разработка ядра системы и базовой архитектуры
- Реализация системы ролей и прав
- Создание базовых сущностей (клиенты, сделки, воронки)
- Разработка партнёрского кабинета (основные функции)
- Внедрение базовой аналитики и отчётов
- Тестирование и отладка базового функционала

### 4.2. Этап 2: Интеграции (1-2 месяца)
- Разработка двусторонней интеграции с AmoCRM
- Создание Telegram-бота с базовыми функциями
- Реализация API для внешних интеграций
- Тестирование и оптимизация интеграций

### 4.3. Этап 3: Каталог компонентов (1 месяц)
- Разработка архитектуры для подключаемых компонентов
- Создание базового набора компонентов
- Реализация механизма включения/отключения компонентов
- Документирование API для разработки новых компонентов

### 4.4. Этап 4: UI/UX (1-2 месяца)
- Доработка интерфейса (адаптивность, темы)
- Реализация drag&drop и inline-редактирования
- Оптимизация скорости работы интерфейса
- Настройка кастомизации интерфейса пользователем

### 4.5. Этап 5: Безопасность (1 месяц)
- Внедрение двухфакторной аутентификации
- Интеграция с сервисами авторизации

---

## 5. Дополнение: Детализированные задачи и технологические рекомендации для ИИ-ассистента

**Введение:**

Этот раздел содержит уникальные рекомендации и задачи из дополнения к ТЗ для MaK 3, которые не были отражены в основном документе.

### 5.1. Реализация Real-time отслеживания статусов заявок для Кабинета Франчайзи
- WebSocket Gateway на NestJS (с Socket.IO и Redis-адаптером)
- События: applicationStatusUpdated, newApplicationNotification
- Система "комнат" для franchiseeId
- Аутентификация/авторизация через JWT
- WebSocket клиент на Next.js (socket.io-client) с подпиской на события, обработкой ошибок и переподключением

### 5.2. Система фоновых задач и очередей
- BullMQ для очередей (notificationsQueue, amoCRMSyncQueue, pipelineActionsQueue)
- Сервисы-продюсеры и обработчики задач в NestJS
- UI для мониторинга очередей (Arena, Bull Dashboard)

### 5.3. Сложные UI компоненты
- Визуальный редактор автоматизаций (dnd-kit, React Flow, Mantine)
- JSON-структура правил автоматизации и сервис для их исполнения
- Конструктор аналитических отчётов (TanStack Table, Recharts/Nivo)
- API для построения отчётов (PostgreSQL/Elasticsearch)

### 5.4. Каталог компонентов
- API и контракты для интеграции компонентов с ядром CRM
- Механизм регистрации и управления бэкенд-модулями (NestJS)
- next/dynamic для динамической загрузки UI-компонентов
- Документация и гайдлайны для разработчиков

### 5.5. Проектирование и опциональная реализация GraphQL API
- Анализ целесообразности GraphQL для сложных сценариев
- Интеграция Apollo Server и Apollo Client (code-first)
- Документирование схемы (GraphiQL, Playground)

### 5.6. Рекомендации по стеку и best practices
- Использование Prisma для ORM в NestJS
- Управление состоянием на фронте (Zustand, Jotai, Redux Toolkit)
- Проверка жизнеспособности React Arborist
- Не откладывать решение по GraphQL

### 5.7. Дополнительные рекомендации по качеству и безопасности
- Пользовательские сообщения об ошибках (Mantine Notifications)
- Интеграция с Sentry
- Graceful Degradation
- Единые соглашения по REST API (множественное число, DTO, пагинация, версионирование)
- Валидация данных (class-validator), защита от OWASP Top 10, secrets в env, rate limiting, helmet, RBAC
- Prettier, ESLint, SOLID/DRY/KISS, TSDoc/JSDoc

### 5.8. Интернационализация и локализация
- Использовать next-i18next/react-i18next, вынести строки в локализации
- Для backend предусмотреть локализацию сообщений

### 5.9. Документирование кода
- Использовать TSDoc для TypeScript, комментарии для сложной логики

- Реализация аудита действий пользователей
- Обеспечение соответствия ФЗ-152

### 4.6. Этап 6: Документация и API (1 месяц)
- Разработка документации API (Swagger/OpenAPI)
- Создание руководств пользователя
- Подготовка технической документации
- Разработка обучающих материалов

### 4.7. Этап 7: Подготовка к расширению (1 месяц)
- Описание best practice для разработки
- Создание гайдлайнов по разработке модулей
- Подготовка инфраструктуры для будущих расширений
- Финальное тестирование и оптимизация

---

## 5. Прочее
- Все компоненты должны быть легко заменяемыми и расширяемыми без остановки системы
- Перед разработкой каждого модуля обязательно исследовать существующие open-source решения и шаблоны
- Все изменения фиксируются в changelog.md с описанием причины и сути изменений
- Все требования могут уточняться и дополняться в процессе реализации по согласованию с заказчиком
- Неограниченное число пользователей системы
- Адаптивный дизайн для различных устройств
- Возможность дорабатывать встроенную CRM под запросы конкретного пользователя (этапы, интеграции, поля, аналитика)

---

_Данное ТЗ является живым документом и может дополняться и уточняться на всех этапах проекта._