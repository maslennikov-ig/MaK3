# Техническое задание на разработку CRM-системы и Telegram-бота для компании MaK CRM

## 1. Общие положения

### 1.1. Цель проекта
Создать единую платформу для эффективного взаимодействия между отделами компании, партнерами и франчайзи, а также для автоматизации и стандартизации бизнес-процессов в сфере кредитного брокериджа.

### 1.2. Задачи проекта
- [ ] Ведение учета клиентов, контрагентов и статусов по ним
- [ ] Детальная аналитика (выручка, KPI, эффективность, партнеры)
- [ ] Обучение партнеров и франчайзи
- [ ] Верификация заемщиков
- [ ] Помощь в разработке кредитных программ и подача заявок в банки
- [ ] Управление клиентскими базами

### 1.3. Целевая аудитория
- Внутренние сотрудники (с ролями и правами)
- Партнеры и Франчайзи

---

## 2. Функциональные требования

### 2.1. CRM-система

#### 2.1.1. База клиентов
- [ ] Список клиентов с контактными данными, разделение по источникам (партнеры, лидогенерация, внешние базы и др.)
- [ ] Импорт/экспорт клиентов (Excel, API, ручной ввод)
- [ ] Сегментация базы по источникам и способу обработки
- [ ] Гибкая настройка статусов
- [ ] Перераспределение невыкупленных лидов
- [ ] Конструктор аналитических отчетов по лидам (имя, телефон, источник, дата, принцип обработки и др.)
- [ ] Доступ только для сотрудников с нужными правами

#### 2.1.2. Личный кабинет партнера
- [ ] Доступ через Telegram-бот и по партнерской ссылке
- [ ] Блоки: о компании, обучение (статьи, видео, шаблоны), помощь (FAQ, связь, чаты)
- [ ] Кабинет компании (реквизиты, ID, статус)
- [ ] Работа с лидами (форма подачи, интеграция с АМО, статусы, комментарии, аналитика, калькулятор прибыли, уведомления)
- [ ] Геймификация и обучение (баллы, мероприятия, домашние задания)
- [ ] Взаиморасчеты (даты, суммы, комиссии, акты)
- [ ] Двухуровневая реферальная программа (ссылки, статистика, статусы, история лидов)
- [ ] Аукцион лидов для франчайзи

#### 2.1.3. Кабинет франчайзи
- [ ] Общая информация (как у партнера)
- [ ] Панель клиента (карточка клиента, сделки, аналитика, статусы, история, документы)
- [ ] Управление лидами (создание, обработка, статусы)
- [ ] Взаимодействие с базой (аукцион, покупка, возврат лидов)
- [ ] Встроенная обучающая система

#### 2.1.4. Роли и права
- [ ] Гибкая настройка ролей: администратор, сотрудник, партнер, франчайзи (и их сотрудники)
- [ ] Разграничение доступа к разделам и данным

#### 2.1.5. Интеграции
- [ ] Двусторонняя интеграция с АМО CRM
- [ ] Открытое API для сторонних сервисов и площадок
- [ ] Интеграция с мессенджерами (Telegram, WhatsApp и др.)

#### 2.1.6. Аналитика и отчеты
- [ ] Гибкий конструктор отчетов (KPI, выручка, эффективность, конверсия, доход партнера и др.)
- [ ] Дашборды для разных ролей

#### 2.1.7. Безопасность
- [ ] Аутентификация и авторизация (использование для авторизация популярных способов)
- [ ] Логирование действий


#### 2.1.9. Автоматизация воронки продаж и действия (Pipeline Actions)
- Для каждой стадии воронки продаж можно настраивать набор автоматизированных действий (action buttons), которые отображаются в карточке сделки/клиента.
- Действия настраиваются администратором MaK CRM, права запуска определяются allowedRoles.
- Примеры возможных действий (расширяемый список):
  - Смена этапа (changeStage)
  - Смена владельца (changeOwner)
  - Автоматическое заполнение полей (autofillFields)
  - Формирование и скачивание документов (generateDocument)
  - Отправка email или SMS (sendEmail, sendSMS)
  - Создание задачи/напоминания (createTask)
  - Запуск webhook или внешнего скрипта (runWebhook, runScript)
  - Добавление/удаление меток (addLabel, removeLabel)
  - Создание или привязка связанных объектов (attachRelated)
  - Отправка данных в сторонние сервисы (integrateExternal)
  - Массовые действия над выбранными сделками (bulkAction)
  - Запрос подтверждения или согласования (requestApproval)
  - Автоматическое создание комментария/заметки (addComment)
  - Перенос в архив/возврат из архива (archiveDeal, restoreDeal)
  - Любое кастомное действие через скрипт или плагин (customAction)
- Действия могут быть расширены в будущем без изменений архитектуры.
- Для каждого действия задаются параметры (config), условия отображения и права запуска.
- В интерфейсе реализуется отдельная панель действий справа в карточке сделки с кнопками.

##### 2.1.9.1. Интерфейс работы с воронками продаж

Интерфейс работы со сделками и клиентами должен быть реализован по принципу трехколоночного представления, аналогично envycrm:

1. **Левая колонка** — Информация о клиенте/сделке:
   - Основные контактные данные клиента
   - Детали сделки (сумма, продукты, дата создания и т.д.)
   - Текущий этап воронки с визуальным отображением прогресса
   - Ответственный сотрудник
   - Источник привлечения
   - Метки и теги
   - Дополнительные поля, настраиваемые администратором

2. **Центральная колонка** — История взаимодействия:
   - Хронологическая лента всех действий и взаимодействий с клиентом
   - Комментарии сотрудников
   - Записи о звонках, встречах, email-переписке
   - История изменения статусов и этапов
   - Файлы и документы
   - Задачи и напоминания
   - Возможность фильтрации истории по типам событий

3. **Правая колонка** — Панель автоматизаций:
   - Кнопки действий, специфичные для текущего этапа воронки
   - Визуальное разделение действий по категориям
   - Индикация доступности действий в зависимости от прав пользователя
   - Подсказки и описания действий при наведении
   - Возможность настройки быстрых действий для конкретного пользователя

##### 2.1.9.2. Настройка воронок и автоматизаций

В административной части системы должен быть реализован интерфейс для настройки воронок продаж и связанных с ними автоматизаций:

1. **Управление воронками продаж**:
   - Создание и редактирование воронок
   - Настройка этапов воронки (название, порядок, цвет, длительность)
   - Определение вероятности закрытия сделки на каждом этапе
   - Настройка доступа к воронкам для разных групп пользователей
   - Возможность создания шаблонов воронок для быстрого применения

2. **Конструктор автоматизаций**:
   - Визуальный редактор для создания автоматизаций без программирования
   - Привязка автоматизаций к конкретным этапам воронки
   - Настройка условий срабатывания автоматизаций (триггеров)
   - Определение последовательности действий при автоматизации
   - Настройка прав доступа к запуску автоматизаций

3. **Типы автоматизаций**:
   - **Автоматические** — срабатывают при наступлении определенного события без участия пользователя (например, при переходе на этап, при истечении времени и т.д.)
   - **Ручные** — запускаются пользователем через кнопки в интерфейсе
   - **Комбинированные** — часть действий выполняется автоматически, часть требует подтверждения пользователя

##### 2.1.9.3. Расширенные возможности автоматизаций

Помимо базовых действий, система должна поддерживать следующие расширенные возможности автоматизаций:

1. **Условные действия** — выполнение действий в зависимости от условий:
   - Проверка значений полей клиента/сделки
   - Проверка истории взаимодействий
   - Проверка прав пользователя
   - Временные условия (время суток, день недели, длительность нахождения на этапе)

2. **Цепочки действий** — последовательное выполнение нескольких действий:
   - Визуальный конструктор цепочек
   - Возможность ветвления в зависимости от результата предыдущего действия
   - Отложенное выполнение действий по расписанию
   - Повторяющиеся действия с заданным интервалом

3. **Интеграционные автоматизации**:
   - Синхронизация данных с amoCRM
   - Отправка данных в сторонние сервисы через API
   - Получение данных из внешних источников
   - Автоматическое создание документов по шаблонам
   - Интеграция с платежными системами

4. **Дополнительные типы автоматизаций**:
   - **Уведомления и напоминания** — отправка уведомлений в Telegram, по email, SMS
   - **Финансовые операции** — создание счетов, актов, фиксация оплат
   - **Управление задачами** — создание, назначение, контроль выполнения задач
   - **Работа с документами** — генерация, отправка, контроль подписания
   - **Аналитические действия** — расчет показателей, обновление отчетов
   - **Интеграция с календарем** — создание встреч, напоминаний о событиях
   - **Автоматическая сегментация** — добавление клиентов в группы по условиям
   - **Скоринг клиентов** — автоматический расчет ценности клиента
   - **Маршрутизация лидов** — автоматическое распределение между сотрудниками

##### 2.1.9.4. Мониторинг и аналитика автоматизаций

Система должна предоставлять инструменты для мониторинга и анализа эффективности автоматизаций:

1. **Журнал выполнения автоматизаций**:
   - История всех запущенных автоматизаций
   - Статус выполнения (успешно, с ошибками, в процессе)
   - Детали выполнения каждого шага
   - Возможность повторного запуска в случае ошибки

2. **Аналитика эффективности**:
   - Статистика использования автоматизаций
   - Влияние автоматизаций на скорость прохождения этапов
   - Конверсия между этапами воронки
   - Выявление узких мест в процессах

3. **Оптимизация процессов**:
   - Рекомендации по улучшению автоматизаций
   - A/B тестирование различных вариантов автоматизаций
   - Предиктивная аналитика для прогнозирования результатов

---

### 2.2. Telegram-бот

#### 2.2.1. Регистрация и аутентификация
- [ ] Регистрация партнера через бота
- [ ] Привязка к личному кабинету CRM
- [ ] Верификация контактов

#### 2.2.2. Работа с лидами
- [ ] Быстрая подача заявки через бота (форма, проверка на дубли, уведомления)
- [ ] Получение статусов по своим лидам
- [ ] Уведомления о важных событиях (статус, комментарии, выплаты)

#### 2.2.3. Обучение и поддержка
- [ ] Доступ к обучающим материалам
- [ ] FAQ, быстрые ответы, связь с менеджером

#### 2.2.4. Геймификация и рефералы
- [ ] Заработок баллов за активность
- [ ] Генерация реферальных ссылок
- [ ] Просмотр статистики по рефералам

#### 2.2.5. Интеграции
- [ ] Взаимодействие с CRM (API, webhooks)
- [ ] Интеграция с чатами поддержки

---

### 2.3. Воронки продаж (Pipelines)
- Все воронки продаж и их стадии централизованно настраиваются администратором MaK CRM.
- Франчайзи и партнеры используют только доступные им воронки без возможности редактирования или создания новых.
- Для каждого клиента (лида) указывается pipelineId (воронка) и stageId (стадия).
- Аналитика и отчёты строятся с учётом стадий и воронок.

### 2.4. Ролевая модель и права доступа (multi-tenant)
- Система поддерживает многоуровневую модель ролей и групп:
  - **owner, admin, employee** — сотрудники MaK CRM с разными уровнями доступа
  - **franchisee_owner, franchisee_employee** — владельцы и сотрудники франчайзи
  - **partner_owner, partner_employee** — владельцы и сотрудники партнёров
- Для каждого пользователя указывается:
  - role (роль)
  - groupType ('company', 'franchisee', 'partner')
  - groupId (идентификатор организации)
  - permissions (детальные права)
- Владельцы франчайзи/партнёров управляют своими сотрудниками и их правами, но не могут дать больше прав, чем имеют сами.
- Все фильтрации данных и аналитика строятся по groupId/groupType пользователя.

#### 2.4.1. Детальное описание ролей и прав

##### Роли сотрудников MaK CRM (groupType: 'company')
- **owner** — владелец системы
  - Полный доступ ко всем функциям и данным системы
  - Управление всеми пользователями, включая администраторов
  - Настройка глобальных параметров системы
  - Доступ к финансовой отчетности и аналитике всех уровней
  - Управление воронками продаж и автоматизациями

- **admin** — администратор системы
Тоже самое, что owner

- **employee** — сотрудник компании
  - Доступ к назначенным клиентам и сделкам
  - Ограниченный доступ к аналитике (только свои показатели)
  - Работа с лидами и клиентами
  - Использование, но не настройка воронок продаж
  - Коммуникация с партнерами и франчайзи

##### Роли франчайзи (groupType: 'franchisee')
- **franchisee_owner** — владелец франшизы
  - Управление сотрудниками своей организации
  - Полный доступ к клиентам своей организации
  - Участие в аукционах лидов
  - Доступ к аналитике своей организации
  - Настройка параметров своей организации
  - Управление финансами и взаиморасчетами

- **franchisee_employee** — сотрудник франчайзи
  - Доступ к назначенным клиентам в рамках своей организации
  - Работа с лидами и сделками
  - Ограниченный доступ к аналитике
  - Использование обучающих материалов

##### Роли партнеров (groupType: 'partner')
- **partner_owner** — владелец партнерской организации
  - Управление сотрудниками своей организации
  - Доступ к клиентам, переданным от своей организации
  - Передача лидов в систему
  - Доступ к аналитике по своим лидам
  - Управление реферальной программой
  - Доступ к финансовой информации и взаиморасчетам

- **partner_employee** — сотрудник партнера
  - Передача лидов в систему
  - Отслеживание статусов своих лидов
  - Доступ к обучающим материалам
  - Ограниченный доступ к аналитике

#### 2.4.2. Матрица доступа к функциям системы

| Функция | owner | admin | employee | franchisee_owner | franchisee_employee | partner_owner | partner_employee |
|---------|-------|-------|----------|------------------|---------------------|---------------|------------------|
| Управление пользователями | ✅ | ✅ | ❌ | ✅* | ❌ | ✅* | ❌ |
| Настройка воронок | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| Создание клиентов | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| Редактирование клиентов | ✅ | ✅ | ✅ | ✅** | ✅** | ✅** | ❌ |
| Удаление клиентов | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| Участие в аукционах | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| Доступ к аналитике | ✅ | ✅ | ✅*** | ✅*** | ✅*** | ✅*** | ✅*** |
| Настройка интеграций | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| Финансовые операции | ✅ | ✅ | ❌ | ✅** | ❌ | ✅** | ❌ |

\* Только для пользователей своей организации  
\** Только для своих клиентов  
\*** Ограниченный доступ в рамках своей области видимости

#### 2.4.3. Реализация RBAC в системе

Система ролей и прав доступа реализуется на двух уровнях:

1. **Уровень API (Backend)**
   - Middleware для проверки ролей и прав на каждый запрос
   - Фильтрация данных на уровне запросов к базе данных
   - Проверка принадлежности объектов к группе пользователя
   - Логирование действий с привязкой к пользователю

2. **Уровень интерфейса (Frontend)**
   - Условный рендеринг компонентов в зависимости от роли
   - Скрытие недоступных функций и элементов управления
   - Отображение только релевантных данных
   - Предотвращение несанкционированных действий

#### 2.4.4. Управление правами и делегирование

- Владелец организации может настраивать детальные права для своих сотрудников
- Система поддерживает временное делегирование прав (например, на время отпуска)
- Для критичных операций может требоваться двухфакторная аутентификация
- История изменений прав доступа сохраняется для аудита
